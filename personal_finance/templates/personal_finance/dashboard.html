{% extends "trading/base.html" %}
{% block title %}Personal Finance{% endblock %}

{% block content %}
<div style="max-width:1200px; margin:0 auto; padding:20px; color:#fff; font-family:sans-serif;">

    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h1 style="margin:0; font-size:24px;">ğŸ’° Personal Finance</h1>
        <div style="display:flex; gap:10px;">
            <a href="{% url 'finance:transactions' %}" style="background:#1e293b; color:#fff; padding:8px 16px; border-radius:8px; text-decoration:none; border:1px solid #334155;">Transactions</a>
            <a href="{% url 'finance:budgets' %}" style="background:#1e293b; color:#fff; padding:8px 16px; border-radius:8px; text-decoration:none; border:1px solid #334155;">Budgets</a>
            <a href="{% url 'finance:goals' %}" style="background:#1e293b; color:#fff; padding:8px 16px; border-radius:8px; text-decoration:none; border:1px solid #334155;">Goals</a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin-bottom:30px;">
        <div style="background:#1e293b; padding:20px; border-radius:12px; border:1px solid #334155;">
            <div style="color:#94a3b8; font-size:12px; text-transform:uppercase;">Monthly Spending</div>
            <div style="font-size:24px; font-weight:bold; color:#fff; margin-top:5px;" id="monthly-spending">${{ monthly_spending }}</div>
        </div>
        <div style="background:#1e293b; padding:20px; border-radius:12px; border:1px solid #334155;">
            <div style="color:#94a3b8; font-size:12px; text-transform:uppercase;">Transactions</div>
            <div style="font-size:24px; font-weight:bold; color:#fff; margin-top:5px;" id="transaction-count">{{ transactions|length }}</div>
        </div>
        <div style="background:#1e293b; padding:20px; border-radius:12px; border:1px solid #334155;">
            <div style="color:#94a3b8; font-size:12px; text-transform:uppercase;">Active Budgets</div>
            <div style="font-size:24px; font-weight:bold; color:#fff; margin-top:5px;">{{ budgets|length }}</div>
        </div>
        <div style="background:#1e293b; padding:20px; border-radius:12px; border:1px solid #334155;">
            <div style="color:#94a3b8; font-size:12px; text-transform:uppercase;">Goals</div>
            <div style="font-size:24px; font-weight:bold; color:#fff; margin-top:5px;">{{ goals|length }}</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div style="display:grid; grid-template-columns:2fr 1fr; gap:20px;">

        <!-- Add Transaction Form -->
        <div style="background:#1e293b; padding:24px; border-radius:12px; border:1px solid #334155;">
            <h2 style="margin:0 0 20px; font-size:18px; color:#fff;">â• Add Transaction</h2>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <select id="tx-category" style="background:#0f172a; color:#fff; padding:10px; border-radius:8px; border:1px solid #334155; font-size:14px;">
                    <option value="">Select Category</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.icon }} {{ cat.name }}</option>
                    {% endfor %}
                </select>
                <input type="number" id="tx-amount" placeholder="Amount ($)" style="background:#0f172a; color:#fff; padding:10px; border-radius:8px; border:1px solid #334155; font-size:14px;">
                <input type="text" id="tx-description" placeholder="Description" style="background:#0f172a; color:#fff; padding:10px; border-radius:8px; border:1px solid #334155; font-size:14px;">
                <input type="date" id="tx-date" style="background:#0f172a; color:#fff; padding:10px; border-radius:8px; border:1px solid #334155; font-size:14px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <label style="color:#94a3b8; font-size:14px;">
                        <input type="checkbox" id="tx-recurring"> Recurring
                    </label>
                    <select id="tx-frequency" style="background:#0f172a; color:#fff; padding:8px; border-radius:8px; border:1px solid #334155; font-size:14px; display:none;">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <button onclick="addTransaction()" style="background:#10b981; color:#fff; padding:10px; border:none; border-radius:8px; cursor:pointer; font-size:15px; font-weight:bold;">Add Transaction</button>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div style="background:#1e293b; padding:24px; border-radius:12px; border:1px solid #334155;">
            <h2 style="margin:0 0 15px; font-size:18px; color:#fff;">ğŸ“‹ Recent Transactions</h2>
            <div id="recent-transactions" style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto;">
                <div style="color:#64748b; text-align:center; padding:20px;">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Budgets + Goals Row -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">

        <!-- Budgets -->
        <div style="background:#1e293b; padding:24px; border-radius:12px; border:1px solid #334155;">
            <h2 style="margin:0 0 15px; font-size:18px; color:#fff;">ğŸ“Š Budgets</h2>
            <div id="budget-list" style="display:flex; flex-direction:column; gap:12px;">
                <div style="color:#64748b; text-align:center;">Loading...</div>
            </div>
        </div>

        <!-- Goals -->
        <div style="background:#1e293b; padding:24px; border-radius:12px; border:1px solid #334155;">
            <h2 style="margin:0 0 15px; font-size:18px; color:#fff;">ğŸ¯ Goals</h2>
            <div id="goal-list" style="display:flex; flex-direction:column; gap:12px;">
                <div style="color:#64748b; text-align:center;">Loading...</div>
            </div>
        </div>
    </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOAD DATA ON PAGE LOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
    loadTransactions();
    loadBudgets();
    loadGoals();

    // Set today's date
    document.getElementById('tx-date').valueAsDate = new Date();

    // Toggle recurring frequency
    document.getElementById('tx-recurring').addEventListener('change', function() {
        document.getElementById('tx-frequency').style.display = this.checked ? 'block' : 'none';
    });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TRANSACTIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTransactions() {
    const response = await fetch('/finance/api/transactions/');
    const transactions = await response.json();
    const container = document.getElementById('recent-transactions');

    if (transactions.length === 0) {
        container.innerHTML = '<div style="color:#64748b; text-align:center; padding:20px;">No transactions yet</div>';
        return;
    }

    container.innerHTML = transactions.slice(0, 8).map(tx => `
        <div style="display:flex; justify-content:space-between; align-items:center; background:#0f172a; padding:10px 14px; border-radius:8px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:20px;">${tx.category__icon || 'ğŸ’°'}</span>
                <div>
                    <div style="color:#fff; font-size:14px;">${tx.description || 'No description'}</div>
                    <div style="color:#64748b; font-size:12px;">${tx.date} ${tx.is_recurring ? 'ğŸ”„ ' + tx.recurring_frequency : ''}</div>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="color:#ef4444; font-weight:bold;">-$${parseFloat(tx.amount).toFixed(2)}</span>
                <button onclick="deleteTransaction(${tx.id})" style="background:none; border:none; color:#64748b; cursor:pointer; font-size:16px;">âœ•</button>
            </div>
        </div>
    `).join('');
}

async function addTransaction() {
    const category = document.getElementById('tx-category').value;
    const amount = document.getElementById('tx-amount').value;
    const description = document.getElementById('tx-description').value;
    const txDate = document.getElementById('tx-date').value;
    const isRecurring = document.getElementById('tx-recurring').checked;
    const frequency = document.getElementById('tx-frequency').value;

    if (!category || !amount) {
        alert('Please select category and enter amount');
        return;
    }

    const response = await fetch('/finance/api/transactions/add/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            category: category,
            amount: amount,
            description: description,
            date: txDate,
            is_recurring: isRecurring,
            recurring_frequency: isRecurring ? frequency : null
        })
    });

    const result = await response.json();
    if (result.success) {
        // Reset form
        document.getElementById('tx-amount').value = '';
        document.getElementById('tx-description').value = '';
        document.getElementById('tx-recurring').checked = false;
        document.getElementById('tx-frequency').style.display = 'none';
        loadTransactions();
        loadSummary();
    } else {
        alert('Error: ' + result.error);
    }
}

async function deleteTransaction(id) {
    const response = await fetch(`/finance/api/transactions/${id}/delete/`, {
        method: 'DELETE'
    });
    const result = await response.json();
    if (result.success) {
        loadTransactions();
    }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BUDGETS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBudgets() {
    const response = await fetch('/finance/api/budgets/');
    const budgets = await response.json();
    const container = document.getElementById('budget-list');

    if (budgets.length === 0) {
        container.innerHTML = '<div style="color:#64748b; text-align:center; padding:10px;">No budgets yet</div>';
        return;
    }

    container.innerHTML = budgets.map(b => `
        <div style="background:#0f172a; padding:12px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                <span style="color:#fff; font-size:14px;">${b.category__icon} ${b.category__name}</span>
                <span style="color:#94a3b8; font-size:13px;">$${parseFloat(b.spent).toFixed(2)} / $${parseFloat(b.monthly_limit).toFixed(2)}</span>
            </div>
            <div style="background:#1e293b; border-radius:4px; height:6px;">
                <div style="background:${b.is_over_threshold ? '#ef4444' : '#10b981'}; width:${Math.min(b.spent_percentage, 100)}%; height:100%; border-radius:4px; transition:width 0.3s;"></div>
            </div>
            <div style="color:${b.is_over_threshold ? '#ef4444' : '#64748b'}; font-size:11px; margin-top:4px;">${b.spent_percentage.toFixed(1)}% used ${b.is_over_threshold ? 'âš ï¸ Over threshold!' : ''}</div>
        </div>
    `).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GOALS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGoals() {
    const response = await fetch('/finance/api/goals/');
    const goals = await response.json();
    const container = document.getElementById('goal-list');

    if (goals.length === 0) {
        container.innerHTML = '<div style="color:#64748b; text-align:center; padding:10px;">No goals yet</div>';
        return;
    }

    container.innerHTML = goals.map(g => `
        <div style="background:#0f172a; padding:12px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                <span style="color:#fff; font-size:14px;">${g.is_completed ? 'âœ…' : 'ğŸ¯'} ${g.name}</span>
                <span style="color:#94a3b8; font-size:13px;">$${parseFloat(g.current_amount).toFixed(2)} / $${parseFloat(g.target_amount).toFixed(2)}</span>
            </div>
            <div style="background:#1e293b; border-radius:4px; height:6px;">
                <div style="background:${g.is_completed ? '#10b981' : '#3b82f6'}; width:${g.progress_percentage}%; height:100%; border-radius:4px; transition:width 0.3s;"></div>
            </div>
            <div style="color:#64748b; font-size:11px; margin-top:4px;">${g.progress_percentage.toFixed(1)}% complete</div>
        </div>
    `).join('');
}
</script>
{% endblock %}
