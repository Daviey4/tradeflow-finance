# =============================================================================
# TRADEFLOW DEVSECOPS PIPELINE
# =============================================================================
# Complete CI/CD pipeline with security scanning
# 
# This pipeline demonstrates:
# - SAST (Static Application Security Testing)
# - DAST (Dynamic Application Security Testing)
# - Dependency scanning
# - Container scanning
# - Secret detection
# - Code quality checks
# - Security reporting
#
# Author: David Alicea
# Purpose: DevSecOps portfolio demonstration
# =============================================================================

name: DevSecOps Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run security scans daily at midnight
    - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual trigger

env:
  PYTHON_VERSION: '3.11'
  DOCKER_IMAGE: tradeflow
  REGISTRY: ghcr.io

jobs:
  # ===========================================================================
  # STAGE 1: CODE QUALITY & LINTING
  # ===========================================================================
  code-quality:
    name: ðŸ“ Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install flake8 black isort pylint mypy

      - name: Run Black (formatting)
        run: black --check --diff .
        continue-on-error: true

      - name: Run isort (import sorting)
        run: isort --check-only --diff .
        continue-on-error: true

      - name: Run Flake8 (linting)
        run: flake8 . --count --statistics --output-file=flake8-report.txt
        continue-on-error: true

      - name: Run Pylint
        run: pylint trading/ --output-format=json > pylint-report.json
        continue-on-error: true

      - name: Upload linting reports
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: |
            flake8-report.txt
            pylint-report.json

  # ===========================================================================
  # STAGE 2: UNIT TESTS
  # ===========================================================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-django

      - name: Run tests with coverage
        run: |
          pytest --cov=trading --cov-report=xml --cov-report=html -v
        env:
          DJANGO_SETTINGS_MODULE: tradeflow.settings

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: coverage.xml
          fail_ci_if_error: false

  # ===========================================================================
  # STAGE 3: SECRET DETECTION
  # ===========================================================================
  secret-scanning:
    name: ðŸ”‘ Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

      - name: Custom secret patterns check
        run: |
          echo "Checking for common secret patterns..."
          
          # Check for hardcoded passwords
          if grep -rn "password\s*=\s*['\"][^'\"]*['\"]" --include="*.py" .; then
            echo "âš ï¸ Potential hardcoded passwords found!"
          fi
          
          # Check for API keys
          if grep -rn "api_key\s*=\s*['\"][^'\"]*['\"]" --include="*.py" .; then
            echo "âš ï¸ Potential hardcoded API keys found!"
          fi
          
          # Check for AWS credentials
          if grep -rn "AKIA[0-9A-Z]{16}" --include="*.py" .; then
            echo "âš ï¸ Potential AWS access keys found!"
          fi
          
          echo "Secret scan complete"

  # ===========================================================================
  # STAGE 4: DEPENDENCY SCANNING (SCA)
  # ===========================================================================
  dependency-scanning:
    name: ðŸ“¦ Dependency Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      # Safety - Python dependency checker
      - name: Run Safety
        run: |
          pip install safety
          safety check --full-report --output json > safety-report.json || true
          safety check --full-report
        continue-on-error: true

      # pip-audit - Another Python vulnerability scanner
      - name: Run pip-audit
        run: |
          pip install pip-audit
          pip-audit --format json --output pip-audit-report.json || true
          pip-audit
        continue-on-error: true

      # Snyk for comprehensive scanning
      - name: Run Snyk
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            safety-report.json
            pip-audit-report.json

  # ===========================================================================
  # STAGE 5: SAST (Static Application Security Testing)
  # ===========================================================================
  sast-scanning:
    name: ðŸ” SAST Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Bandit - Python security linter
      - name: Run Bandit
        run: |
          pip install bandit
          bandit -r trading/ -f json -o bandit-report.json || true
          bandit -r trading/ -f txt -o bandit-report.txt || true
          echo "=== Bandit Security Report ==="
          cat bandit-report.txt
        continue-on-error: true

      # Semgrep - Pattern-based scanning
      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/python
            p/django
            p/owasp-top-ten
            p/security-audit
          generateSarif: true
        continue-on-error: true

      # CodeQL - GitHub's security scanner
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

      - name: Upload SAST reports
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: |
            bandit-report.json
            bandit-report.txt

  # ===========================================================================
  # STAGE 6: BUILD DOCKER IMAGE
  # ===========================================================================
  build:
    name: ðŸ³ Build Container
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===========================================================================
  # STAGE 7: CONTAINER SCANNING
  # ===========================================================================
  container-scanning:
    name: ðŸ‹ Container Scanning
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build image for scanning
        run: docker build -t ${{ env.DOCKER_IMAGE }}:scan .

      # Trivy - Container vulnerability scanner
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:scan
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy (table output)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE }}:scan
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

      # Grype - Alternative container scanner
      - name: Run Grype
        uses: anchore/scan-action@v3
        with:
          image: ${{ env.DOCKER_IMAGE }}:scan
          fail-build: false
          severity-cutoff: high

      # Dockle - Container best practices
      - name: Run Dockle
        uses: erzz/dockle-action@v1
        with:
          image: ${{ env.DOCKER_IMAGE }}:scan
          failure-threshold: high
          exit-code: 0

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # ===========================================================================
  # STAGE 8: DAST (Dynamic Application Security Testing)
  # ===========================================================================
  dast-scanning:
    name: ðŸŒ DAST Scanning
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name != 'pull_request'
    services:
      tradeflow:
        image: ${{ needs.build.outputs.image-tag }}
        ports:
          - 8000:8000
        env:
          DEBUG: 'True'
          SECRET_KEY: 'test-secret-key-for-ci'
          DATABASE_URL: 'sqlite:///db.sqlite3'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for application to start
        run: |
          echo "Waiting for application to be ready..."
          timeout 60 bash -c 'until curl -s http://localhost:8000/health/ > /dev/null; do sleep 2; done'
          echo "Application is ready!"

      # OWASP ZAP - Dynamic security scanner
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:8000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
        continue-on-error: true

      - name: Run OWASP ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.9.0
        with:
          target: 'http://localhost:8000'
          rules_file_name: '.zap/rules.tsv'
        continue-on-error: true

      # Nuclei - Fast vulnerability scanner
      - name: Run Nuclei
        uses: projectdiscovery/nuclei-action@main
        with:
          target: http://localhost:8000
          templates: cves,vulnerabilities,misconfiguration
          output: nuclei-report.txt
        continue-on-error: true

      - name: Upload DAST reports
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: |
            nuclei-report.txt

  # ===========================================================================
  # STAGE 9: INFRASTRUCTURE AS CODE SCANNING
  # ===========================================================================
  iac-scanning:
    name: ðŸ—ï¸ IaC Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Checkov - IaC security scanner
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: dockerfile,github_actions
          output_format: cli,sarif
          output_file_path: console,checkov-results.sarif
          soft_fail: true

      # Hadolint - Dockerfile linter
      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning
        continue-on-error: true

      - name: Upload IaC scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

  # ===========================================================================
  # STAGE 10: SECURITY REPORT GENERATION
  # ===========================================================================
  security-report:
    name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    needs: [secret-scanning, dependency-scanning, sast-scanning, container-scanning, dast-scanning, iac-scanning]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: security-reports

      - name: Generate consolidated report
        run: |
          echo "# ðŸ” Security Scan Report" > SECURITY_REPORT.md
          echo "Generated: $(date)" >> SECURITY_REPORT.md
          echo "Commit: ${{ github.sha }}" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          echo "## ðŸ“‹ Scan Summary" >> SECURITY_REPORT.md
          echo "| Scan Type | Status |" >> SECURITY_REPORT.md
          echo "|-----------|--------|" >> SECURITY_REPORT.md
          echo "| Secret Detection | ${{ needs.secret-scanning.result }} |" >> SECURITY_REPORT.md
          echo "| Dependency Scanning | ${{ needs.dependency-scanning.result }} |" >> SECURITY_REPORT.md
          echo "| SAST | ${{ needs.sast-scanning.result }} |" >> SECURITY_REPORT.md
          echo "| Container Scanning | ${{ needs.container-scanning.result }} |" >> SECURITY_REPORT.md
          echo "| DAST | ${{ needs.dast-scanning.result }} |" >> SECURITY_REPORT.md
          echo "| IaC Scanning | ${{ needs.iac-scanning.result }} |" >> SECURITY_REPORT.md
          echo "" >> SECURITY_REPORT.md
          
          echo "## ðŸ“ Detailed Reports" >> SECURITY_REPORT.md
          echo "All detailed reports are available as artifacts." >> SECURITY_REPORT.md
          
          cat SECURITY_REPORT.md

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: SECURITY_REPORT.md

      - name: Post summary to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('SECURITY_REPORT.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # ===========================================================================
  # STAGE 11: DEPLOY (Only on main branch)
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [security-report]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to production
        run: |
          echo "Deploying to production..."
          # Add your deployment commands here
          # Examples:
          # - kubectl apply -f k8s/
          # - aws ecs update-service
          # - railway up
          # - render deploy

      - name: Notify deployment
        run: |
          echo "âœ… Deployment complete!"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
